name: Lint
description: Setup test environment, run tests and upload coverage
inputs:
  python-version:
    required: true
runs:
  using: "composite"
  steps:
    - name: Install uv and Python
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        python-version: ${{ matrix.python-version }}
    - name: Setup uv venv
      shell: bash
      run: |
        uv sync --locked --all-extras --group dev
    - name: Lint with ruff
      shell: bash
      run: |
        uv run ruff check --select I coredis tests
        uv run ruff check coredis tests
    - name: Check types
      shell: bash
      run: |
        uv run mypy coredis
    - name: Check auto generated sources
      shell: bash
      run: |
        make templated-sources
        if [ ! -z "$(git diff coredis)" ];
        then
          echo "Auto-generated source are not up to date"
          git diff
          exit 1
        fi;
