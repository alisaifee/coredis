name: Run tests
description: Setup test environment, run tests and upload coverage
inputs:
  python-version:
    required: true
  test-params:
    required: true
  redis-version:
    required: true
  compiled:
    required: false
    default: true
  anyio-backend:
    required: false
    default: "asyncio"
  runtime-type-checks:
    required: false
    default: true
  orjson:
    required: false
    default: false
  coverage:
    required: false
    default: true
  uvloop:
    required: false
    default: false
runs:
  using: "composite"
  steps:
    - name: Install uv and Python
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        python-version: ${{ inputs.python-version }}
    - name: Setup uv venv
      shell: bash
      run: |
        uv sync --locked --all-extras --group ci
    - name: Compile with mypyc
      if: ${{ inputs.compiled == 'true' }}
      shell: bash
      run: uv run mypyc coredis/constants/ coredis/parser.py coredis/_packer.py coredis/_utils.py
    - name: Tests
      env:
        COREDIS_UVLOOP: ${{ inputs.uvloop == 'true' && 'True' || 'False' }}
        COREDIS_ANYIO_BACKEND: ${{ inputs.anyio-backend }}
        HOST_OS: linux
        CI: "True"
        COREDIS_REDIS_VERSION: ${{inputs.redis-version}}
        COREDIS_RUNTIME_CHECKS: ${{inputs.runtime-type-checks == 'true' && 'True' || 'False'}}
        COMPOSE_PARALLEL_LIMIT: 1
        UV_GROUP: ${{ inputs.orjson == 'true' && 'orjson' || 'dev' }}
      shell: bash
      run: |
        echo "Runtime checks: $COREDIS_RUNTIME_CHECKS"
        echo "UVLoop: $COREDIS_UVLOOP"
        echo "CI: $CI"
        uv run --group $UV_GROUP pytest --timeout=60 --reverse --reruns 2 --cov=coredis --cov-report=xml --junitxml=junit.xml -o junit_family=legacy ${{ inputs.test-params }}
    - name: Upload coverage to Codecov
      if: ${{ inputs.coverage == 'true' }}
      uses: codecov/codecov-action@v5

    - name: Upload test coverage to Codecov
      if: ${{ inputs.coverage == 'true' && !cancelled() }}
      uses: codecov/codecov-action@v5
      with:
        files: ./junit.xml
        report_type: test_results
